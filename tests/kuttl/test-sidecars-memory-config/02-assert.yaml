---
# Verify that app using default memory settings has the correct default values
apiVersion: apps/v1
kind: Deployment
metadata:
  name: test-app-default-api
  namespace: test-sidecars-memory-config
spec:
  template:
    spec:
      initContainers:
        - name: otel-collector
          image: ghcr.io/os-observability/redhat-opentelemetry-collector/redhat-opentelemetry-collector:0.107.0
          resources:
            requests:
              memory: "32Mi"  # Default memory request
            limits:
              memory: "64Mi"  # Default memory limit
          volumeMounts:
            - name: test-app-default-otel-config
              mountPath: /etc/otelcol/
          restartPolicy: Always
      volumes:
        - name: config-secret
          secret:
            defaultMode: 420
            secretName: test-app-default
        - name: test-app-default-otel-config
          configMap:
            name: test-app-default-otel-config
            optional: true
---
# Verify that app using environment-level memory settings has the correct env values
apiVersion: apps/v1
kind: Deployment
metadata:
  name: test-app-env-level-api
  namespace: test-sidecars-memory-config
spec:
  template:
    spec:
      initContainers:
        - name: otel-collector
          image: ghcr.io/os-observability/redhat-opentelemetry-collector/redhat-opentelemetry-collector:0.107.0
          resources:
            requests:
              memory: "16Mi"  # Environment-level memory request
            limits:
              memory: "48Mi"  # Environment-level memory limit
          volumeMounts:
            - name: test-app-env-level-otel-config
              mountPath: /etc/otelcol/
          restartPolicy: Always
      volumes:
        - name: config-secret
          secret:
            defaultMode: 420
            secretName: test-app-env-level
        - name: test-app-env-level-otel-config
          configMap:
            name: test-app-env-level-otel-config
            optional: true
---
# Verify that app with memory override has the correct app-level values
apiVersion: apps/v1
kind: Deployment
metadata:
  name: test-app-override-api
  namespace: test-sidecars-memory-config
spec:
  template:
    spec:
      initContainers:
        - name: otel-collector
          image: ghcr.io/os-observability/redhat-opentelemetry-collector/redhat-opentelemetry-collector:0.107.0
          resources:
            requests:
              memory: "8Mi"  # App-level override memory request
            limits:
              memory: "128Mi"  # App-level override memory limit
          volumeMounts:
            - name: test-app-override-otel-config
              mountPath: /etc/otelcol/
          restartPolicy: Always
      volumes:
        - name: config-secret
          secret:
            defaultMode: 420
            secretName: test-app-override
        - name: test-app-override-otel-config
          configMap:
            name: test-app-override-otel-config
            optional: true
---
# Verify that app with partial override has mixed values (app request + env limit)
apiVersion: apps/v1
kind: Deployment
metadata:
  name: test-app-partial-override-api
  namespace: test-sidecars-memory-config
spec:
  template:
    spec:
      initContainers:
        - name: otel-collector
          image: ghcr.io/os-observability/redhat-opentelemetry-collector/redhat-opentelemetry-collector:0.107.0
          resources:
            requests:
              memory: "4Mi"  # App-level override memory request
            limits:
              memory: "48Mi"  # Environment-level memory limit (no app override)
          volumeMounts:
            - name: test-app-partial-override-otel-config
              mountPath: /etc/otelcol/
          restartPolicy: Always
      volumes:
        - name: config-secret
          secret:
            defaultMode: 420
            secretName: test-app-partial-override
        - name: test-app-partial-override-otel-config
          configMap:
            name: test-app-partial-override-otel-config
            optional: true
---
# Verify that deployment in the job app has correct memory settings
apiVersion: apps/v1
kind: Deployment
metadata:
  name: test-app-with-job-worker
  namespace: test-sidecars-memory-config
spec:
  template:
    spec:
      initContainers:
        - name: otel-collector
          image: ghcr.io/os-observability/redhat-opentelemetry-collector/redhat-opentelemetry-collector:0.107.0
          resources:
            requests:
              memory: "24Mi"  # App-level override memory request
            limits:
              memory: "32Mi"  # App-level override memory limit
          volumeMounts:
            - name: test-app-with-job-otel-config
              mountPath: /etc/otelcol/
          restartPolicy: Always
      volumes:
        - name: config-secret
          secret:
            defaultMode: 420
            secretName: test-app-with-job
        - name: test-app-with-job-otel-config
          configMap:
            name: test-app-with-job-otel-config
            optional: true
---
# Verify that CronJob has correct memory settings
apiVersion: batch/v1
kind: CronJob
metadata:
  name: test-app-with-job-migration
  namespace: test-sidecars-memory-config
spec:
  jobTemplate:
    spec:
      template:
        spec:
          containers:
          - name: test-app-with-job-migration
          initContainers:
          - name: otel-collector
            image: ghcr.io/os-observability/redhat-opentelemetry-collector/redhat-opentelemetry-collector:0.107.0
            resources:
              requests:
                memory: "12Mi"  # App-level override memory request for job
              limits:
                memory: "16Mi"  # App-level override memory limit for job
            volumeMounts:
            - mountPath: /etc/otelcol/
              name: test-app-with-job-otel-config
            restartPolicy: Always
          volumes:
          - name: config-secret
            secret:
              defaultMode: 420
              secretName: test-app-with-job
          - configMap:
              defaultMode: 420
              name: test-app-with-job-otel-config
            name: test-app-with-job-otel-config
