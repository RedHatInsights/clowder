---
# Test 1: No CPU limit in pod spec + NO CPU limit in env defaults
# Expected: No CPU limit should be set on the deployment
apiVersion: cloud.redhat.com/v1alpha1
kind: ClowdEnvironment
metadata:
  name: test-cpu-no-limit
spec:
  targetNamespace: test-cpu-no-limit
  providers:
    web:
      port: 8000
      mode: operator
    metrics:
      port: 9000
      mode: operator
      path: "/metrics"
    kafka:
      mode: none
    db:
      mode: none
    logging:
      mode: none
    objectStore:
      mode: none
    inMemoryDb:
      mode: none
  # Resource defaults WITHOUT CPU limit
  resourceDefaults:
    limits:
      memory: 1024Mi
    requests:
      cpu: 30m
      memory: 512Mi
---
apiVersion: cloud.redhat.com/v1alpha1
kind: ClowdApp
metadata:
  name: test-app-no-cpu-limit
  namespace: test-cpu-no-limit
spec:
  envName: test-cpu-no-limit
  deployments:
  - name: processor
    podSpec:
      image: quay.io/psav/clowder-hello
      # No CPU limit specified in pod spec
---
# Test 2: CPU limit explicitly set in pod spec
# Expected: The pod's CPU limit should be used
apiVersion: cloud.redhat.com/v1alpha1
kind: ClowdEnvironment
metadata:
  name: test-cpu-pod-limit
spec:
  targetNamespace: test-cpu-pod-limit
  providers:
    web:
      port: 8000
      mode: operator
    metrics:
      port: 9000
      mode: operator
      path: "/metrics"
    kafka:
      mode: none
    db:
      mode: none
    logging:
      mode: none
    objectStore:
      mode: none
    inMemoryDb:
      mode: none
  # Resource defaults WITHOUT CPU limit
  resourceDefaults:
    limits:
      memory: 1024Mi
    requests:
      cpu: 30m
      memory: 512Mi
---
apiVersion: cloud.redhat.com/v1alpha1
kind: ClowdApp
metadata:
  name: test-app-pod-cpu-limit
  namespace: test-cpu-pod-limit
spec:
  envName: test-cpu-pod-limit
  deployments:
  - name: processor
    podSpec:
      image: quay.io/psav/clowder-hello
      # Explicit CPU limit in pod spec
      resources:
        limits:
          cpu: 200m
          memory: 512Mi
        requests:
          cpu: 50m
          memory: 256Mi
---
# Test 3: No CPU limit in pod spec + CPU limit in env defaults
# Expected: The env's CPU limit default should be used
apiVersion: cloud.redhat.com/v1alpha1
kind: ClowdEnvironment
metadata:
  name: test-cpu-env-limit
spec:
  targetNamespace: test-cpu-env-limit
  providers:
    web:
      port: 8000
      mode: operator
    metrics:
      port: 9000
      mode: operator
      path: "/metrics"
    kafka:
      mode: none
    db:
      mode: none
    logging:
      mode: none
    objectStore:
      mode: none
    inMemoryDb:
      mode: none
  # Resource defaults WITH CPU limit
  resourceDefaults:
    limits:
      cpu: 400m
      memory: 1024Mi
    requests:
      cpu: 30m
      memory: 512Mi
---
apiVersion: cloud.redhat.com/v1alpha1
kind: ClowdApp
metadata:
  name: test-app-env-cpu-limit
  namespace: test-cpu-env-limit
spec:
  envName: test-cpu-env-limit
  deployments:
  - name: processor
    podSpec:
      image: quay.io/psav/clowder-hello
      # No CPU limit in pod spec - should use env default
