name: PR E2E Tests (CodeBuild)

on:
  issue_comment:
    types: [created]

permissions:
  id-token: write  # Required for OIDC authentication with AWS
  contents: read
  pull-requests: write  # To post comments back to the PR
  statuses: write  # To create commit status checks

jobs:
  trigger-codebuild:
    # Only run on PR comments that contain /test-e2e
    if: |
      github.event.issue.pull_request &&
      contains(github.event.comment.body, '/test-e2e')

    runs-on: ubuntu-latest

    steps:
      - name: Check user permissions
        id: check-permissions
        uses: actions/github-script@v7
        with:
          script: |
            const username = context.payload.comment.user.login;

            try {
              const { data: permissionData } = await github.rest.repos.getCollaboratorPermissionLevel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                username: username
              });

              const permission = permissionData.permission;
              console.log(`User ${username} has permission: ${permission}`);

              // Allow admin, write, and maintain permissions
              const allowedPermissions = ['admin', 'write', 'maintain'];

              if (!allowedPermissions.includes(permission)) {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  body: `@${username} Sorry, you don't have permission to trigger E2E tests. This command is restricted to repository maintainers.`
                });

                core.setFailed(`User ${username} does not have sufficient permissions (has: ${permission}, needs: ${allowedPermissions.join(', ')})`);
              }

              core.setOutput('allowed', 'true');
            } catch (error) {
              console.error('Error checking permissions:', error);
              core.setFailed('Failed to check user permissions');
            }

      - name: React to comment
        if: steps.check-permissions.outputs.allowed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'rocket'
            });

      - name: Get PR details
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            core.setOutput('sha', pr.data.head.sha);
            core.setOutput('ref', pr.data.head.ref);
            core.setOutput('repo', pr.data.head.repo.clone_url);

      - name: Create pending status check
        if: steps.check-permissions.outputs.allowed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: '${{ steps.pr.outputs.sha }}',
              state: 'pending',
              context: 'CodeBuild / E2E Tests',
              description: 'Running E2E tests in CodeBuild...'
            });

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_CODEBUILD_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Run CodeBuild
        id: codebuild
        uses: aws-actions/aws-codebuild-run-build@v1
        with:
          project-name: clowder-pr-check
          source-version-override: ${{ steps.pr.outputs.sha }}
          env-vars-for-codebuild: |
            GITHUB_PR_NUMBER,
            GITHUB_SHA,
            GITHUB_REF,
            GITHUB_ACTOR,
            GITHUB_REPOSITORY
        env:
          GITHUB_PR_NUMBER: ${{ github.event.issue.number }}
          GITHUB_SHA: ${{ steps.pr.outputs.sha }}
          GITHUB_REF: ${{ steps.pr.outputs.ref }}
          GITHUB_ACTOR: ${{ github.actor }}
          GITHUB_REPOSITORY: ${{ github.repository }}

      - name: Update status check to in-progress
        if: always() && steps.codebuild.outputs.aws-build-id
        uses: actions/github-script@v7
        with:
          script: |
            const buildId = '${{ steps.codebuild.outputs.aws-build-id }}';
            const region = '${{ secrets.AWS_REGION }}';
            const encodedBuildId = encodeURIComponent(buildId);
            const consoleUrl = `https://${region}.console.aws.amazon.com/codesuite/codebuild/projects/clowder-pr-check/build/${encodedBuildId}/`;

            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: '${{ steps.pr.outputs.sha }}',
              state: 'pending',
              context: 'CodeBuild / E2E Tests',
              description: 'E2E tests in progress...',
              target_url: consoleUrl
            });

      - name: Update status check on success
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const buildId = '${{ steps.codebuild.outputs.aws-build-id }}';
            const region = '${{ secrets.AWS_REGION }}';
            const encodedBuildId = encodeURIComponent(buildId);
            const consoleUrl = `https://${region}.console.aws.amazon.com/codesuite/codebuild/projects/clowder-pr-check/build/${encodedBuildId}/`;

            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: '${{ steps.pr.outputs.sha }}',
              state: 'success',
              context: 'CodeBuild / E2E Tests',
              description: 'E2E tests passed',
              target_url: consoleUrl
            });

      - name: Update status check on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const buildId = '${{ steps.codebuild.outputs.aws-build-id }}';
            const region = '${{ secrets.AWS_REGION }}';

            let consoleUrl = null;
            let description = 'E2E tests failed';

            if (buildId) {
              const encodedBuildId = encodeURIComponent(buildId);
              consoleUrl = `https://${region}.console.aws.amazon.com/codesuite/codebuild/projects/clowder-pr-check/build/${encodedBuildId}/`;
            } else {
              description = 'Failed to start E2E tests';
            }

            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: '${{ steps.pr.outputs.sha }}',
              state: 'failure',
              context: 'CodeBuild / E2E Tests',
              description: description,
              target_url: consoleUrl
            });
